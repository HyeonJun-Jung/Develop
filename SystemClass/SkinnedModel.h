#pragma once
#include "..\stdafx.h"
#include "ModelStructure.h"

//
//	기본적인 메쉬들과 텍스쳐, 애니메이션 정보 등을 담은 클래스
//	ModelLoader를 통해서 생성되어 ModelManager의 ModelMap으로 저장된다.
//	ModelManager를 통해 한번 로드된 모델은 ModelMap에서 불러와진다.
//

class SkinnedModel
{
public:
	SkinnedModel(); 
	SkinnedModel(const SkinnedModel& model);
	~SkinnedModel();

public:
	void Render(ID3D11DeviceContext* devcon);
	void SetMarterials(ID3D11DeviceContext* devcon, int MeshIndex);

	vector<MtMesh*>* GetMeshList() { return &MeshList; }
	vector<Animation>* GetAnimationList() { return &AnimationList; }
	Animation* GetAnimation(int index) { return &AnimationList[index]; }
	vector<boneInfo>* GetBoneList() { return &BoneInfos; };
	map<string, int>* GetBoneMap() { return &BoneMap; }
	int GetBoneNum() { return BoneInfos.size(); }
	NodeInfo* GetRootNode() { return RootNode; };
	NodeInfo* GetMoveNode() { return MoveNode; }
	XMFLOAT3* GetMaxPos() { return &MaxPos; }
	XMFLOAT3* GetMinPos() { return &MinPos; }
	Resource_Type GetResourceType();
	PxConvexMeshGeometry& GetConvexMeshGeometry() { return ConvexMeshGeometry;}
	PxBoxGeometry& GetBoxGeometry() { return BoxGeometry; }
	PxCapsuleGeometry& GetCapsuleGeometry() { return CapsuleGeometry; }

	XMMATRIX GetRootNodeTransform(int AnimationIndex, float AnimationTime, NodeInfo* node);
	void UpdateBoneFinalMatrix(int AnimationIndex, float AnimationTime, XMMATRIX* BoneFinalTransform);

	void ChangeAnimation(int prevAni, int nextAni, float animationTime, float LerpTime, XMMATRIX* BoneFinalTransform);
	float GetFrameTime(int animationIdx, int frameIdx);

	float GetCurFrameTime(int animationIdx, float animationTime);
	float GetNextFrameTime(int animationIdx, float animationTime);
	
private:
	void ReadNodeHierarchy(int AnimationIndex, float AnimaitonTime, NodeInfo* node, const XMMATRIX& parentTransform, XMMATRIX* BoneFinalTransform);
	void ReadNodeHierarchy(int prevAni, int nextAni, float AnimaitonTime, float LerpTime, NodeInfo* node, const XMMATRIX& parentTransform, XMMATRIX* BoneFinalTransform);
	int FindAniNodeIndex(const Animation* animation, const string nodeName);
	void processMoveNode();
	

private:
	// 정점 버퍼, 인덱스 버퍼, 마테리얼 정보
	vector<MtMesh*> MeshList;

	// 애니메이션 정보
	vector<Animation> AnimationList;

	// Bone 정보
	map<string, int> BoneMap;
	vector<boneInfo> BoneInfos;

	// Node 계층 구조
	NodeInfo* RootNode = new NodeInfo;
	NodeInfo* MoveNode = nullptr;

	// Physx Material
	PxConvexMeshGeometry ConvexMeshGeometry;
	PxBoxGeometry BoxGeometry;
	PxCapsuleGeometry CapsuleGeometry;

	// Obb 최대 최소
	XMFLOAT3 MaxPos, MinPos;
	
	// Last Frame Postion
	XMFLOAT3 LastFramePosition;


public:
	XMMATRIX GlobalInverseTransform = XMMatrixIdentity();

	// 사용되는 마테리얼 정보
	MarterialType Mt_Type;
};

